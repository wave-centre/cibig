---
title: 'IRD/CIRAD trainning to R, the statistical programming language'
author: "Sebastien Cunnac & Emmanuel Paradis"
date: "Sept. 7-11, 2015"
output: html_document
---

```{r setup, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(error = TRUE, collapse = TRUE)
```

# `ggplot2` package


## Brief intro to `ggplot2`

* R in a nutshell 2nd edition: *"ggplot2 1 has become one of the most popular R packages. ggplot2 is a great tool for producing readable charts. But more importantly, ggplot2 uses a language for describing how to plot data called the grammar of graphics."*


`ggplot2` [cheat sheet](https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf)


* ggplot2 tutorials:

http://rpubs.com/hadley/ggplot2-layers by H Wickham **short and easy)**

http://rpubs.com/hadley/ggplot2-toolbox by H Wickham **longer**

http://www.ling.upenn.edu/~joseff/avml2012/ **more advanced but still feasible**


http://zevross.com/blog/2014/08/04/beautiful-plotting-in-r-a-ggplot2-cheatsheet-3/ **Long with lots of info on how to modify the aspect of the plot**

http://rpubs.com/RobinLovelace/intro-spatial **ggplot2:ggmap to plot SPATIAL DATA**


## `ggplot2` in action (movie)

```{r}
library(ggplot2)
summary(movies)

## create a local copy of my movie to modify it
myMov <- movies

# Let's first create a few more columns

# Add a categorical variable recording whether budget is available
myMov <- transform(myMov, budgetKnown = !is.na(budget))

# Add another categorical variable by makin a factor with rating
myMov <- transform(myMov, ratingCat = cut(rating, breaks = pretty(rating, 5)))
```

## some histograms

```{r}
# histogram of the number of movies listed by year

p <- ggplot(data = myMov, aes(x = year))

p + geom_bar()

# like with other functions if you assign a plot, NOTHING is "printed" in the graphical device
myHist <- p + geom_bar(binwidth = 10)

# Now we display it
print(myHist)

# a ggplot2 graphic is first of all an OBJECT
str(myHist)


# change the color of the fill of the bars
h1 <- p + geom_bar(fill = "yellow")
h1

# lets show side by side the distribution dependant on whether budget is known
h2 <- p + geom_bar(aes(fill = budgetKnown), position = "dodge")
h2

# two plots side by side
#install.packages("gridExtra")
library("gridExtra")
print(grid.arrange(h1, h2))

```

## A bar plot with a categorical variable


```{r}

bp <- ggplot(data = myMov, aes(x = mpaa))
bp + geom_bar()

# Let's save a png file of the plot
ggsave(filename = "barPlotMPAA.png", plot = last_plot())

```

# Bivariates plots

```{r}
## x-y plot
xy <- ggplot(data = myMov, aes(x = rating, y = votes))
xy + geom_point()

# Movies with known budget have more votes ?
xy + geom_point(aes(color = budgetKnown)) 
# it looks like there is some overplotting, let's add some transparency
xy + geom_point(aes(color = budgetKnown), alpha = 0.2) 

# Let's look at the relation between rating and budget
xy <- ggplot(data = myMov, aes(x = rating, y = budget))
xy + geom_point()
# Is a high budget a garantee of high ratings? Bof...

```

```{r}
# bar plots with color dependent on a third variable
aggregMov <- aggregate(formula = length ~ mpaa + ratingCat, data = myMov, FUN = mean)

bpf <- ggplot(data = aggregMov, aes(x = ratingCat, y = length))
bpf + geom_bar(stat = "identity")

# bars are "dodged"
bpf + geom_bar(stat = "identity", aes(fill = mpaa), position = position_dodge())

# relative length of movies by rating and by mpaa
bpf + geom_bar(stat = "identity", aes(fill = mpaa), position = position_fill())
```






```{r}
# box plot
bxp <- ggplot(data = myMov, aes(x = mpaa, y = budget))
bxp + geom_boxplot() # kind of hard to see, let's change the y scale 

bxp + geom_boxplot() + scale_y_log10()

# Adult movies have very low budgets ?!
```


```{r}
# line plots
# Lets look a the evolution of budgets as time goes bby.default()

bt <-  ggplot(data = myMov, aes(x = year, y = budget))
bt + geom_point()
bt + geom_point() + geom_smooth()

## Or something similar

meanBudgByYear <- aggregate(formula = budget ~ year, data = myMov, FUN = median, na.action = na.omit)

bt <-  ggplot(data = meanBudgByYear, aes(x = year, y = budget))
bt + geom_line() +
    labs(title = "Movie budget trends", x = "YEAR", y = "Budget ($)")
```





## Some facetting

```{r}
# There are lots of data points and we will try to just get a random sample out of them.

someMov <- subset(myMov, !is.na(budget), -(r1:r10)) # take only rows with no NA and delete r colomns

someMov <- someMov[ sample(1:nrow(someMov), size = 200), ] # sample a random subset of rows

fac <- ggplot(data = someMov, aes(x = length, y = votes))

fac + geom_point()
  
fac + geom_point() + facet_wrap(facets = ~ mpaa)

gr <- fac + geom_point() + facet_grid(facets = ratingCat ~ mpaa)
gr

gr + theme_bw()

gr + theme_minimal()

```


